<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Villa Availability Checker</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    .available { background: #c6f7d0; color: #006400; font-weight: bold; }
    .booked { background: #ffbfbf; color: #8b0000; }
    input, button { padding: 10px; margin-right: 10px; margin-bottom: 10px; }
    button { cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
    button:hover { background-color: #0056b3; }
    #loading { display: none; color: #666; font-style: italic; }
  </style>
</head>
<body>

  <h2>Villa Availability Checker</h2>

  <label>Check-in: </label>
  <input type="date" id="checkin">

  <label>Check-out: </label>
  <input type="date" id="checkout">

  <button id="checkBtn">Check Availability</button>
  <span id="loading">Loading data...</span>

  <table id="availabilityTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Season</th>
        <th>Omah Lor</th> 
        <th>Omah Kidul</th>
        <th>Omah Wetan</th>
        <th>Omah Kulon</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6">Please select your check-in and check-out dates and click "Check Availability".</td></tr>
    </tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwH1_S9bIQ8YtV5OihsxJknCXGuTmHTiU4Sk_7EW9jWT2QHFuTEZ0MGnRa7E1tOhzh1pQ/exec"; 
    
    let sheetData = [];

    /**
     * Helper function to safely parse date strings from the Google Sheet API 
     * which often return dates in a format like "12/01/2025" instead of YYYY-MM-DD.
     * This ensures the Date constructor works correctly.
     */
    function parseSheetDate(dateString) {
      if (!dateString) return null;
      // Try to recognize common formats (MM/DD/YYYY or DD/MM/YYYY)
      const parts = dateString.split(/[-\/]/);
      
      // Assuming the API returns MM/DD/YYYY format. If your API returns DD/MM/YYYY, 
      // you will need to swap the first two elements: new Date(parts[2], parts[1] - 1, parts[0]);
      if (parts.length === 3) {
          // Date constructor: year, month (0-indexed), day
          return new Date(parts[2], parts[0] - 1, parts[1]); 
      }
      
      // Fallback for standard ISO formats
      const standardDate = new Date(dateString);
      return isNaN(standardDate) ? null : standardDate;
    }

    async function loadData() {
      const loading = document.getElementById("loading");
      const tbody = document.querySelector("#availabilityTable tbody");
      
      try {
        loading.style.display = "inline";
        const res = await fetch(API_URL);
        const json = await res.json();
        
        sheetData = Array.isArray(json) ? json : json.data;

        if(!sheetData) {
            console.error("Could not find data array.");
            tbody.innerHTML = "<tr><td colspan='6'>Error loading data format</td></tr>";
        }
      } catch (error) {
        console.error("Fetch error:", error);
        tbody.innerHTML = "<tr><td colspan='6'>Error connecting to Google Sheet</td></tr>";
      } finally {
        loading.style.display = "none";
      }
    }

    function getStatusCell(value) {
      const valStr = String(value || "").toLowerCase().trim();
      if (valStr === "" || valStr === "null" || valStr === "undefined") return "Available";
      return "Booked";
    }

    function getClass(status) {
      return status === "Available" ? "available" : "booked";
    }

    function renderTable(data) {
      const tbody = document.querySelector("#availabilityTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6'>No dates found in this range.</td></tr>";
        return;
      }

      data.forEach(row => {
        // --- Data Mapping ---
        const omahLor = getStatusCell(row["Room A"] || row["room a"]);
        const omahKidul = getStatusCell(row["Room B"] || row["room b"]);
        const omahWetan = getStatusCell(row["Room C"] || row["room c"]);
        const omahKulon = getStatusCell(row["Room D"] || row["room d"]);

        const tr = document.createElement("tr");
        
        // --- Date Display Fix ---
        let displayDate = row.date;
        const rowDateObj = parseSheetDate(row.date);
        
        if (rowDateObj) {
            // Display the date in the local format (e.g., 12/1/2025)
            displayDate = rowDateObj.toLocaleDateString(); 
        } else {
            // Show error message if date couldn't be parsed
            displayDate = `ERROR: ${row.date}`;
        }
        // ------------------------

        tr.innerHTML = `
          <td>${displayDate}</td>
          <td>${row.season || row.Season || '-'}</td>
          <td class="${getClass(omahLor)}">${omahLor}</td>
          <td class="${getClass(omahKidul)}">${omahKidul}</td>
          <td class="${getClass(omahWetan)}">${omahWetan}</td>
          <td class="${getClass(omahKulon)}">${omahKulon}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterByDateRange() {
      const checkinValue = document.getElementById("checkin").value;
      const checkoutValue = document.getElementById("checkout").value;

      if (!checkinValue || !checkoutValue) {
        alert("Please select both check-in and check-out dates.");
        return;
      }

      // Input dates are in YYYY-MM-DD format, which is easily parsed
      const startDate = new Date(checkinValue);
      const endDate = new Date(checkoutValue);

      const filtered = sheetData.filter(row => {
        // --- Filtering Fix ---
        const rowDate = parseSheetDate(row.date);
        
        // Skip filtering if the date could not be parsed
        if (!rowDate) return false; 

        // Compare timestamps
        return rowDate.getTime() >= startDate.getTime() && rowDate.getTime() < endDate.getTime();
      });

      renderTable(filtered);
    }

    document.getElementById("checkin").addEventListener("change", function () {
      const checkinDate = this.value;
      const checkout = document.getElementById("checkout");

      let minDate = new Date(checkinDate);
      minDate.setDate(minDate.getDate() + 1);

      checkout.min = minDate.toISOString().split("T")[0];

      if (checkout.value && checkout.value <= checkinDate) {
        checkout.value = "";
      }
    });

    document.getElementById("checkBtn").addEventListener("click", filterByDateRange);

    loadData();
  </script>
</body>
</html>
